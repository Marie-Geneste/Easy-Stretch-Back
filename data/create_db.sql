BEGIN;

CREATE DOMAIN "email" AS text CHECK (
    value ~ '^[a-zA-Z0-9.!#$%&''*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$'
);

DROP TABLE IF EXISTS "user", "stretch", "role", "category","user_stretch";

CREATE TABLE
    IF NOT EXISTS "user" (
        "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "email" email NOT NULL UNIQUE,
        "password" VARCHAR NOT NULL,
        "username" VARCHAR(15) NOT NULL,
        "biography" VARCHAR(255) DEFAULT NULL,
       /* "favorites" INTEGER [],*/ /* A voir si on garde car apparement la jointure ferait office de relation entre user et stretch */
        "role_id" INTEGER NOT NULL REFERENCES "role"("id")
    );

CREATE TABLE
    IF NOT EXISTS "stretch" (
        "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "title" VARCHAR(255) NOT NULL NOT NULL,
        "description_content" VARCHAR NOT NULL,
        "main_image" VARCHAR,
        "description_image" VARCHAR,
        "category_id" INTEGER REFERENCES "category"("id"),
    );

CREATE TABLE
    IF NOT EXISTS "user_stretch" (
        "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "user_id" INTEGER NOT NULL REFERENCES "user"("id"),
        "stretch_id" INTEGER NOT NULL REFERENCES "stretch"("id"),
        UNIQUE ("user_id", "stretch_id")
    );

CREATE TABLE
    IF NOT EXISTS "role" (
        "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "name" VARCHAR(12)
    );

CREATE TABLE
    IF NOT EXISTS "category" (
        "id" INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        "name" VARCHAR(255) NOT NULL,
    );

COMMIT;
